---
phase: 03-monitoring-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00003_mentions.sql
  - src/types/database.ts
  - src/lib/validations/mention.ts
autonomous: true

must_haves:
  truths:
    - "Mentions table exists with all required columns"
    - "TypeScript types match database schema"
    - "Zod schemas exist for AI classification and reply generation"
  artifacts:
    - path: "supabase/migrations/00003_mentions.sql"
      provides: "Mentions table with RLS policies"
      contains: "CREATE TABLE public.mentions"
    - path: "src/types/database.ts"
      provides: "Mention TypeScript interface"
      contains: "interface Mention"
    - path: "src/lib/validations/mention.ts"
      provides: "Zod schemas for AI outputs"
      exports: ["PostIntentSchema", "DraftReplySchema", "mentionStatusSchema"]
  key_links:
    - from: "src/types/database.ts"
      to: "supabase/migrations/00003_mentions.sql"
      via: "schema definition mirrors migration"
      pattern: "Mention.*reddit_post_id"
---

<objective>
Create the database schema and TypeScript types for the mentions system.

Purpose: Establish the data foundation for storing Reddit mentions, AI classifications, and draft replies. This enables all downstream monitoring and UI work.
Output: Migration file, updated TypeScript types, and Zod validation schemas.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-monitoring-engine/03-RESEARCH.md

@supabase/migrations/00002_phase2_tables.sql
@src/types/database.ts
@src/lib/validations/product.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mentions migration</name>
  <files>supabase/migrations/00003_mentions.sql</files>
  <action>
Create SQL migration for mentions table following existing patterns from 00002_phase2_tables.sql:

**Table: public.mentions**
Columns:
- id: UUID PRIMARY KEY DEFAULT gen_random_uuid()
- product_id: UUID REFERENCES products(id) ON DELETE CASCADE NOT NULL
- user_id: UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL
- reddit_post_id: TEXT NOT NULL (Reddit's post ID like "abc123")
- reddit_permalink: TEXT NOT NULL (full URL to post)
- reddit_title: TEXT NOT NULL
- reddit_content: TEXT (selftext, can be empty)
- reddit_author: TEXT NOT NULL
- reddit_subreddit: TEXT NOT NULL
- reddit_created_at: TIMESTAMPTZ NOT NULL
- intent: TEXT NOT NULL ('pain_point' | 'recommendation_request')
- confidence: INTEGER NOT NULL (0-100)
- draft_reply: TEXT (can be null if generation failed)
- status: TEXT NOT NULL DEFAULT 'pending' ('pending' | 'approved' | 'discarded' | 'regenerated')
- created_at: TIMESTAMPTZ DEFAULT now()
- updated_at: TIMESTAMPTZ DEFAULT now()

**Constraints:**
- UNIQUE(product_id, reddit_post_id) - composite key for deduplication
- CHECK(confidence >= 0 AND confidence <= 100)
- CHECK(status IN ('pending', 'approved', 'discarded', 'regenerated'))
- CHECK(intent IN ('pain_point', 'recommendation_request'))

**RLS Policies (4 CRUD policies):**
- "Users can view own mentions" - SELECT WHERE auth.uid() = user_id
- "Users can create own mentions" - INSERT WITH CHECK auth.uid() = user_id
- "Users can update own mentions" - UPDATE WHERE auth.uid() = user_id
- "Users can delete own mentions" - DELETE WHERE auth.uid() = user_id

**Indexes:**
- idx_mentions_user_status ON mentions(user_id, status) - for filtered list queries
- idx_mentions_product ON mentions(product_id) - for product-specific queries
- Unique constraint on (product_id, reddit_post_id) creates implicit index

**Triggers:**
- on_mention_updated - reuse handle_updated_at function from 00001

**Table: public.monitoring_state**
Simple table to track last monitoring run:
- id: INTEGER PRIMARY KEY DEFAULT 1 CHECK(id = 1) - singleton pattern
- last_checked_at: TIMESTAMPTZ
- last_run_stats: JSONB (optional stats from last run)

RLS: Service role only access (no authenticated user policies needed)
  </action>
  <verify>File exists with correct SQL syntax. Check for:
- CREATE TABLE public.mentions with all columns
- All 4 RLS policies
- Unique constraint on (product_id, reddit_post_id)
- on_mention_updated trigger
- monitoring_state table</verify>
  <done>Migration file ready to be executed in Supabase Dashboard</done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types</name>
  <files>src/types/database.ts</files>
  <action>
Extend src/types/database.ts with Mention types following existing patterns:

**Add Mention interface:**
```typescript
export interface Mention {
  id: string
  product_id: string
  user_id: string
  reddit_post_id: string
  reddit_permalink: string
  reddit_title: string
  reddit_content: string | null
  reddit_author: string
  reddit_subreddit: string
  reddit_created_at: string
  intent: 'pain_point' | 'recommendation_request'
  confidence: number
  draft_reply: string | null
  status: 'pending' | 'approved' | 'discarded' | 'regenerated'
  created_at: string
  updated_at: string
}
```

**Add MonitoringState interface:**
```typescript
export interface MonitoringState {
  id: number
  last_checked_at: string | null
  last_run_stats: {
    products: number
    posts_found: number
    mentions_created: number
  } | null
}
```

**Add to Database interface Tables:**
- mentions table with Row, Insert, Update types
- monitoring_state table (service role only, can be minimal)

Follow existing patterns for Insert/Update type derivations using Omit and Partial.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Mention and MonitoringState types are exported and usable</done>
</task>

<task type="auto">
  <name>Task 3: Create Zod validation schemas</name>
  <files>src/lib/validations/mention.ts</files>
  <action>
Create new file src/lib/validations/mention.ts with Zod schemas for AI structured outputs:

**PostIntentSchema** - for classifyPostIntent response:
```typescript
export const PostIntentSchema = z.object({
  intent: z.enum(['pain_point', 'recommendation_request', 'not_relevant'])
    .describe('The primary intent of the post'),
  confidence: z.number().min(0).max(100)
    .describe('Confidence score as percentage (0-100)'),
  reasoning: z.string()
    .describe('Brief explanation of why this classification was chosen'),
})

export type PostIntent = z.infer<typeof PostIntentSchema>
```

**DraftReplySchema** - for generateDraftReply response:
```typescript
export const DraftReplySchema = z.object({
  reply: z.string()
    .describe('The draft reply text, plain text only (no markdown)'),
})

export type DraftReply = z.infer<typeof DraftReplySchema>
```

**mentionStatusSchema** - for validating status updates:
```typescript
export const mentionStatusSchema = z.enum(['pending', 'approved', 'discarded', 'regenerated'])

export type MentionStatus = z.infer<typeof mentionStatusSchema>
```

Include proper imports from zod (import { z } from 'zod').
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Zod schemas exported and ready for use in OpenAI client and actions</done>
</task>

</tasks>

<verification>
1. [ ] Migration file exists at supabase/migrations/00003_mentions.sql
2. [ ] src/types/database.ts exports Mention interface
3. [ ] src/lib/validations/mention.ts exports PostIntentSchema, DraftReplySchema, mentionStatusSchema
4. [ ] `npx tsc --noEmit` passes
5. [ ] `npm run build` passes
</verification>

<success_criteria>
- Database schema for mentions is defined with all columns and constraints
- TypeScript types match the database schema exactly
- Zod schemas are ready for use with OpenAI zodResponseFormat
- All code compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-monitoring-engine/03-01-SUMMARY.md`
</output>

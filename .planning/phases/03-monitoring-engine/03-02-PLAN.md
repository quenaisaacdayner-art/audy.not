---
phase: 03-monitoring-engine
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/reddit/client.ts
autonomous: true

must_haves:
  truths:
    - "System can fetch posts from a subreddit"
    - "Posts can be filtered by keywords"
    - "Private/banned subreddits are handled silently"
    - "Rate limiting returns graceful error"
  artifacts:
    - path: "src/lib/reddit/client.ts"
      provides: "Reddit JSON API client"
      exports: ["fetchSubredditPosts", "filterPostsByKeywords", "RedditPost"]
      min_lines: 60
  key_links:
    - from: "src/lib/reddit/client.ts"
      to: "https://www.reddit.com/r/{subreddit}/new.json"
      via: "fetch call"
      pattern: "reddit\\.com.*\\.json"
---

<objective>
Create a Reddit client for fetching public posts from subreddits.

Purpose: Enable the monitoring engine to discover new Reddit posts matching user-configured subreddits and keywords.
Output: Reddit client module with fetchSubredditPosts and filterPostsByKeywords functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-monitoring-engine/03-RESEARCH.md

@src/lib/firecrawl/client.ts (for Result pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Reddit client</name>
  <files>src/lib/reddit/client.ts</files>
  <action>
Create new file src/lib/reddit/client.ts with Reddit JSON API client:

**Types:**
```typescript
export interface RedditPost {
  id: string           // Reddit's post ID (e.g., "1abc23d")
  title: string
  selftext: string     // Post body (empty string for link posts)
  author: string
  subreddit: string    // Without r/ prefix
  permalink: string    // e.g., "/r/SaaS/comments/abc123/title/"
  created_utc: number  // Unix timestamp
  score: number
  num_comments: number
  url: string          // For link posts, the external URL
  is_self: boolean     // true for text posts
}

interface RedditListingResponse {
  kind: 'Listing'
  data: {
    children: Array<{
      kind: 't3'  // t3 = post
      data: RedditPost
    }>
    after: string | null
    before: string | null
  }
}

export interface FetchResult {
  success: boolean
  posts: RedditPost[]
  error?: string
}
```

**Constants:**
- USER_AGENT = 'AudyBot/1.0 (Reddit Monitoring)'

**fetchSubredditPosts function:**
```typescript
export async function fetchSubredditPosts(
  subreddit: string,
  limit: number = 25
): Promise<FetchResult>
```

Implementation:
1. Build URL: `https://www.reddit.com/r/${subreddit}/new.json?limit=${limit}`
2. Make fetch request with User-Agent header
3. Handle response codes:
   - 429: Return { success: false, posts: [], error: 'Rate limited by Reddit' }
   - 403/404: Return { success: true, posts: [] } (silent skip per CONTEXT.md decision)
   - Other errors: Return { success: false, posts: [], error: `HTTP ${status}` }
4. Parse JSON and extract posts from children array
5. Return { success: true, posts }
6. Wrap in try/catch for network errors

**filterPostsByKeywords function:**
```typescript
export function filterPostsByKeywords(
  posts: RedditPost[],
  keywords: string[]
): RedditPost[]
```

Implementation:
1. Convert all keywords to lowercase
2. For each post, combine title + selftext into searchText (lowercase)
3. Return posts where any keyword appears in searchText
4. Use .some() for early exit on first match

Example:
```typescript
const lowerKeywords = keywords.map(k => k.toLowerCase())
return posts.filter(post => {
  const searchText = `${post.title} ${post.selftext}`.toLowerCase()
  return lowerKeywords.some(keyword => searchText.includes(keyword))
})
```
  </action>
  <verify>Test by importing the module and checking types compile:
1. `npx tsc --noEmit` passes
2. Functions are exported correctly</verify>
  <done>Reddit client can fetch posts from any public subreddit and filter by keywords</done>
</task>

</tasks>

<verification>
1. [ ] src/lib/reddit/client.ts exists
2. [ ] Exports fetchSubredditPosts, filterPostsByKeywords, RedditPost type
3. [ ] User-Agent header is set
4. [ ] 403/404 errors return empty posts (not errors)
5. [ ] `npx tsc --noEmit` passes
6. [ ] `npm run build` passes
</verification>

<success_criteria>
- Reddit client fetches posts from public subreddits via JSON API
- Keyword filtering works case-insensitively on title + body
- Private/banned subreddits handled gracefully (empty result, not error)
- Rate limiting handled gracefully with error message
</success_criteria>

<output>
After completion, create `.planning/phases/03-monitoring-engine/03-02-SUMMARY.md`
</output>

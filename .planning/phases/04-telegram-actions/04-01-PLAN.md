---
phase: 04-telegram-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00004_regeneration_count.sql
  - src/types/database.ts
  - src/lib/telegram/notifications.ts
autonomous: true

must_haves:
  truths:
    - "Mention records can track regeneration count"
    - "Notification messages are properly HTML-formatted"
    - "Inline keyboards have approve, regenerate, discard buttons"
  artifacts:
    - path: "supabase/migrations/00004_regeneration_count.sql"
      provides: "Schema migration for regeneration_count column"
      contains: "ALTER TABLE mentions ADD COLUMN regeneration_count"
    - path: "src/types/database.ts"
      provides: "Updated Mention type with regeneration_count"
      contains: "regeneration_count"
    - path: "src/lib/telegram/notifications.ts"
      provides: "Notification formatting and sending functions"
      exports: ["sendMentionNotification", "sendBatchNotifications"]
  key_links:
    - from: "src/lib/telegram/notifications.ts"
      to: "src/lib/telegram/bot.ts"
      via: "imports bot instance"
      pattern: "import.*bot.*from.*bot"
    - from: "src/lib/telegram/notifications.ts"
      to: "src/types/database.ts"
      via: "uses Mention type"
      pattern: "import.*Mention.*from.*database"
---

<objective>
Create the notification infrastructure for Telegram: database schema for tracking regenerations, TypeScript types, and a notification module with HTML formatting and inline keyboard buttons.

Purpose: Foundation for sending formatted mention notifications with action buttons to users via Telegram.
Output: Migration file, updated types, and notification module ready for integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-telegram-actions/04-CONTEXT.md
@.planning/phases/04-telegram-actions/04-RESEARCH.md
@src/lib/telegram/bot.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for regeneration_count</name>
  <files>supabase/migrations/00004_regeneration_count.sql</files>
  <action>
Create migration to add `regeneration_count` column to mentions table:

```sql
-- Add regeneration count to mentions
ALTER TABLE mentions ADD COLUMN regeneration_count INTEGER DEFAULT 0 NOT NULL;

-- Add comment for documentation
COMMENT ON COLUMN mentions.regeneration_count IS 'Number of times draft has been regenerated, max 3';
```

This tracks how many times a user has regenerated the draft reply for a mention. Per CONTEXT.md, limit is 3 attempts.
  </action>
  <verify>File exists at supabase/migrations/00004_regeneration_count.sql and contains ALTER TABLE statement</verify>
  <done>Migration file created with regeneration_count column addition</done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types</name>
  <files>src/types/database.ts</files>
  <action>
Update the Mention interface to include regeneration_count:

1. Add to Mention interface:
   - `regeneration_count: number` (after `status` field)

2. Update Database type for mentions table:
   - In Insert type: make regeneration_count optional (has DEFAULT)
   - In Update type: include regeneration_count as updatable

Keep existing type structure intact. Add the new field in the appropriate position.
  </action>
  <verify>TypeScript compilation passes: `npx tsc --noEmit`</verify>
  <done>Mention type includes regeneration_count, Database types updated</done>
</task>

<task type="auto">
  <name>Task 3: Create notification module</name>
  <files>src/lib/telegram/notifications.ts</files>
  <action>
Create notification module with these exports:

1. **escapeHtml(text: string): string**
   - Replace `&` with `&amp;`
   - Replace `<` with `&lt;`
   - Replace `>` with `&gt;`

2. **formatMentionNotification(mention: Mention): string**
   - HTML format: `<b>New opportunity in r/{subreddit}</b>`
   - Include escaped title as `<b>{title}</b>`
   - Include escaped draft reply (or "Draft generation failed" if null)
   - Include `<a href="{permalink}">View on Reddit</a>` link

3. **createMentionKeyboard(mentionId: string): InlineKeyboard**
   - Import `InlineKeyboard` from 'grammy'
   - Three buttons on one row: `Approve` (`approve:{id}`), `Regenerate` (`regen:{id}`), `Discard` (`discard:{id}`)

4. **sendMentionNotification(chatId: number, mention: Mention): Promise<{success: boolean, error?: string}>**
   - Import bot from './bot'
   - Return early with error if bot is null
   - Call `bot.api.sendMessage` with:
     - parse_mode: 'HTML'
     - reply_markup: createMentionKeyboard(mention.id)
     - link_preview_options: { is_disabled: true }
   - Wrap in try/catch, log errors, return result pattern

5. **sendBatchNotifications(chatId: number, mentions: Mention[]): Promise<{sent: number, failed: number}>**
   - Loop through mentions, call sendMentionNotification for each
   - Add 1500ms delay between messages (rate limiting per CONTEXT.md)
   - Track sent/failed counts

Import Mention type from '@/types/database'.
  </action>
  <verify>TypeScript compilation passes: `npx tsc --noEmit`</verify>
  <done>Notification module exports all functions, HTML formatting handles edge cases, inline keyboard created correctly</done>
</task>

</tasks>

<verification>
1. Migration file exists: `ls supabase/migrations/00004_regeneration_count.sql`
2. TypeScript types compile: `npx tsc --noEmit`
3. Notification module exports are correct: grep for exported functions
</verification>

<success_criteria>
- [ ] Migration adds regeneration_count column to mentions table
- [ ] Mention type includes regeneration_count: number
- [ ] notifications.ts exports sendMentionNotification and sendBatchNotifications
- [ ] InlineKeyboard creates three action buttons
- [ ] HTML escaping handles special characters
- [ ] All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-telegram-actions/04-01-SUMMARY.md`
</output>

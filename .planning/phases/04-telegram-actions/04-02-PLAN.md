---
phase: 04-telegram-actions
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/lib/telegram/bot.ts
  - src/app/api/cron/monitor/route.ts
autonomous: true

must_haves:
  truths:
    - "User receives Telegram notification when new mention is created"
    - "User can tap Approve and mention status changes to approved"
    - "User can tap Regenerate and receive new draft in new message"
    - "User can tap Discard and mention status changes to discarded"
    - "Regeneration is capped at 3 attempts with alert on limit"
  artifacts:
    - path: "src/lib/telegram/bot.ts"
      provides: "Callback query handlers for approve, regenerate, discard"
      contains: "bot.callbackQuery"
    - path: "src/app/api/cron/monitor/route.ts"
      provides: "Notification sending after mention creation"
      contains: "sendMentionNotification"
  key_links:
    - from: "src/lib/telegram/bot.ts"
      to: "supabase mentions table"
      via: "service role client update"
      pattern: "supabase.*mentions.*update"
    - from: "src/lib/telegram/bot.ts"
      to: "src/lib/openai/client.ts"
      via: "generateDraftReply for regeneration"
      pattern: "import.*generateDraftReply"
    - from: "src/app/api/cron/monitor/route.ts"
      to: "src/lib/telegram/notifications.ts"
      via: "import sendMentionNotification"
      pattern: "import.*sendMentionNotification"
---

<objective>
Wire up callback handlers for inline button actions and integrate notification sending into the monitoring cron job.

Purpose: Complete the Telegram notification flow - users receive notifications and can act on them directly from chat.
Output: Working approve/regenerate/discard buttons and automatic notifications on new mentions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-telegram-actions/04-CONTEXT.md
@.planning/phases/04-telegram-actions/04-RESEARCH.md
@.planning/phases/04-telegram-actions/04-01-SUMMARY.md
@src/lib/telegram/bot.ts
@src/lib/telegram/notifications.ts
@src/app/api/cron/monitor/route.ts
@src/lib/openai/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add callback query handlers to bot</name>
  <files>src/lib/telegram/bot.ts</files>
  <action>
Extend existing bot.ts to handle inline button callbacks. Add after the existing /start handler inside the `if (bot && supabase)` block:

**1. Import InlineKeyboard from grammy:**
```typescript
import { Bot, InlineKeyboard } from 'grammy'
```

**2. Import generateDraftReply:**
```typescript
import { generateDraftReply } from '@/lib/openai/client'
```

**3. Add escapeHtml helper function** (same as in notifications.ts, for use in reply messages):
```typescript
function escapeHtml(text: string): string {
  return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
}
```

**4. Add approve callback handler:**
```typescript
bot.callbackQuery(/^approve:(.+)$/, async (ctx) => {
  const mentionId = ctx.match[1]
  try {
    const { error } = await supabase
      .from('mentions')
      .update({ status: 'approved', updated_at: new Date().toISOString() })
      .eq('id', mentionId)

    if (error) throw error

    await ctx.answerCallbackQuery({ text: 'Approved! Ready to post.' })
    await ctx.editMessageReplyMarkup({ reply_markup: undefined })
  } catch (error) {
    console.error('Approve error:', error)
    await ctx.answerCallbackQuery({ text: 'Failed to approve. Try again.' })
  }
})
```

**5. Add discard callback handler:**
```typescript
bot.callbackQuery(/^discard:(.+)$/, async (ctx) => {
  const mentionId = ctx.match[1]
  try {
    const { error } = await supabase
      .from('mentions')
      .update({ status: 'discarded', updated_at: new Date().toISOString() })
      .eq('id', mentionId)

    if (error) throw error

    await ctx.answerCallbackQuery({ text: 'Discarded.' })
    await ctx.editMessageReplyMarkup({ reply_markup: undefined })
  } catch (error) {
    console.error('Discard error:', error)
    await ctx.answerCallbackQuery({ text: 'Failed to discard. Try again.' })
  }
})
```

**6. Add regenerate callback handler:**
- Fetch mention with product and persona (use Supabase join)
- Check regeneration_count >= 3, show alert if limit reached
- Call `ctx.answerCallbackQuery({ text: 'Generating new draft...' })`
- Call generateDraftReply with post, product, persona
- If failed, reply with error message
- Update mention: set draft_reply, increment regeneration_count
- Send NEW message (not edit) with new draft and keyboard
- Include attempt label: "(attempt X/3)" or "(final attempt)"
- If at limit after regen (count = 3), buttons still show (user can approve/discard)

**7. Add catch-all callback handler** (prevents stuck loading spinner):
```typescript
bot.on('callback_query:data', async (ctx) => {
  console.warn('Unknown callback query:', ctx.callbackQuery.data)
  await ctx.answerCallbackQuery()
})
```

**Key implementation details for regenerate:**
- Join query: `mentions` with `products(name, description, url)` and persona via user_id
- Persona table is `personas`, access via `.eq('user_id', mention.user_id)` separately or use a subquery
- Use InlineKeyboard for the new message keyboard (same buttons as original)
- Handle persona being null (use empty defaults)
  </action>
  <verify>TypeScript compilation passes: `npx tsc --noEmit`</verify>
  <done>All three callback handlers registered, regeneration respects 3-attempt limit, catch-all prevents stuck spinners</done>
</task>

<task type="auto">
  <name>Task 2: Integrate notifications into monitoring cron</name>
  <files>src/app/api/cron/monitor/route.ts</files>
  <action>
Extend the monitoring cron to send Telegram notifications after creating mentions.

**1. Import sendMentionNotification:**
```typescript
import { sendMentionNotification } from '@/lib/telegram/notifications'
```

**2. After successful mention creation (where `stats.mentions_created++` is called), add notification logic:**

```typescript
if (mentionResult.success && mentionResult.id) {
  stats.mentions_created++

  // Fetch user's telegram connection
  const { data: telegramConnection } = await supabase
    .from('telegram_connections')
    .select('telegram_chat_id')
    .eq('user_id', product.user_id)
    .single()

  if (telegramConnection?.telegram_chat_id) {
    // Fetch the full mention for notification
    const { data: fullMention } = await supabase
      .from('mentions')
      .select('*')
      .eq('id', mentionResult.id)
      .single()

    if (fullMention) {
      await sendMentionNotification(telegramConnection.telegram_chat_id, fullMention)

      // Rate limit: 1.5s delay between notifications per CONTEXT.md
      await new Promise(resolve => setTimeout(resolve, 1500))
    }
  }
}
```

**3. Handle missing Telegram connection gracefully:**
- If user hasn't connected Telegram, skip notification silently
- Mention still exists in database, visible in web UI

**Important:** The Supabase client here uses `createClient()` from server.ts which should work for reading telegram_connections (service-role context in cron). If RLS blocks, the select will return null and we skip gracefully.
  </action>
  <verify>TypeScript compilation passes: `npx tsc --noEmit`</verify>
  <done>Cron sends Telegram notification after each mention creation, rate limiting applied, missing connection handled gracefully</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Telegram notification system with inline action buttons</what-built>
  <how-to-verify>
1. Run migration: Execute 00004_regeneration_count.sql in Supabase Dashboard
2. Deploy to Vercel preview
3. Ensure you have a product with subreddits configured
4. Trigger the monitoring cron manually via Vercel: GET /api/cron/monitor with CRON_SECRET header
5. Check Telegram for notification with three buttons (Approve, Regenerate, Discard)
6. Test Approve: Tap button, should see "Approved! Ready to post" and buttons disappear
7. Test Regenerate: Tap button, should see "Generating..." then new message with new draft
8. Test Discard: Tap button, should see "Discarded." and buttons disappear
9. Test regen limit: On same mention, tap Regenerate 3 times, 4th should show alert "Regeneration limit reached"
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Bot handlers registered: grep for callbackQuery in bot.ts
3. Cron imports notification: grep for sendMentionNotification in route.ts
4. Full integration test via Vercel preview deployment
</verification>

<success_criteria>
- [ ] TELE-01: Notification sent when mention created (via cron integration)
- [ ] TELE-02: Notification includes title, subreddit, draft, link (via HTML formatting)
- [ ] TELE-03: Approve button updates status to 'approved'
- [ ] TELE-04: Regenerate button generates new draft, sends new message
- [ ] TELE-05: Discard button updates status to 'discarded'
- [ ] Regeneration capped at 3 attempts per mention
- [ ] Rate limiting (1.5s delay) between batch notifications
- [ ] Human verification confirms full flow works
</success_criteria>

<output>
After completion, create `.planning/phases/04-telegram-actions/04-02-SUMMARY.md`
</output>

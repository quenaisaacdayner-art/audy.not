---
phase: 01-foundation-authentication
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - src/components/auth/auth-modal.tsx
  - src/components/auth/signup-form.tsx
  - src/components/auth/login-form.tsx
  - src/actions/auth.ts
  - src/app/(auth)/auth/callback/route.ts
autonomous: true

must_haves:
  truths:
    - "User can open signup modal from landing page"
    - "User can submit email/password and create account"
    - "User can click Google button and initiate OAuth flow"
    - "Validation errors appear inline under form fields"
    - "OAuth callback exchanges code for session"
  artifacts:
    - path: "src/components/auth/auth-modal.tsx"
      provides: "Modal container for auth forms"
      exports: ["AuthModal"]
    - path: "src/components/auth/signup-form.tsx"
      provides: "Signup form with email/password and Google OAuth"
      exports: ["SignupForm"]
    - path: "src/components/auth/login-form.tsx"
      provides: "Login form with email/password and Google OAuth"
      exports: ["LoginForm"]
    - path: "src/actions/auth.ts"
      provides: "Server actions for signup and login"
      exports: ["signUp", "signIn", "signOut"]
    - path: "src/app/(auth)/auth/callback/route.ts"
      provides: "OAuth callback handler"
      exports: ["GET"]
  key_links:
    - from: "src/components/auth/signup-form.tsx"
      to: "src/actions/auth.ts"
      via: "form action"
      pattern: "action=.*signUp"
    - from: "src/app/(auth)/auth/callback/route.ts"
      to: "src/lib/supabase/server.ts"
      via: "createClient import"
      pattern: "import.*createClient.*server"
---

<objective>
Create the authentication UI components and server actions for email/password and Google OAuth flows.

Purpose: This plan implements the user-facing authentication experience. Users interact with modal forms to sign up or log in, and server actions handle the actual authentication with Supabase.

Output: Working auth modal with signup/login forms, server actions for authentication, and OAuth callback handler.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@.planning/phases/01-foundation-authentication/01-02-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server actions for authentication</name>
  <files>
    src/actions/auth.ts
  </files>
  <action>
    Create src/actions/ directory and auth.ts with server actions.

    **src/actions/auth.ts**:
    ```typescript
    'use server'

    import { createClient } from '@/lib/supabase/server'
    import { redirect } from 'next/navigation'
    import { signupSchema, loginSchema } from '@/lib/validations/auth'

    export type AuthResult = {
      error?: string
      fieldErrors?: Record<string, string[]>
    }

    export async function signUp(formData: FormData): Promise<AuthResult> {
      const validatedFields = signupSchema.safeParse({
        email: formData.get('email'),
        password: formData.get('password'),
      })

      if (!validatedFields.success) {
        return { fieldErrors: validatedFields.error.flatten().fieldErrors }
      }

      const supabase = await createClient()
      const { email, password } = validatedFields.data

      const { error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          emailRedirectTo: `${process.env.NEXT_PUBLIC_SITE_URL}/auth/callback`,
        },
      })

      if (error) {
        // Generic message for security (don't reveal if email exists)
        return { error: 'Unable to create account. Please try again.' }
      }

      redirect('/onboarding')
    }

    export async function signIn(formData: FormData): Promise<AuthResult> {
      const validatedFields = loginSchema.safeParse({
        email: formData.get('email'),
        password: formData.get('password'),
      })

      if (!validatedFields.success) {
        return { fieldErrors: validatedFields.error.flatten().fieldErrors }
      }

      const supabase = await createClient()
      const { email, password } = validatedFields.data

      const { error } = await supabase.auth.signInWithPassword({
        email,
        password,
      })

      if (error) {
        // Generic message for security
        return { error: 'Invalid credentials' }
      }

      // Check if onboarding completed
      const { data: profile } = await supabase
        .from('profiles')
        .select('onboarding_completed')
        .single()

      if (profile?.onboarding_completed) {
        redirect('/dashboard')
      } else {
        redirect('/onboarding')
      }
    }

    export async function signOut(): Promise<void> {
      const supabase = await createClient()
      await supabase.auth.signOut()
      redirect('/')
    }
    ```
  </action>
  <verify>
    Run `npm run build` to confirm TypeScript compiles
    Verify src/actions/auth.ts exports signUp, signIn, signOut
  </verify>
  <done>
    Server actions created for signup, login, and logout. Actions validate input with Zod, interact with Supabase Auth, and redirect appropriately based on onboarding status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create OAuth callback route handler</name>
  <files>
    src/app/(auth)/auth/callback/route.ts
  </files>
  <action>
    Create the (auth) route group and callback handler.

    Create directories: src/app/(auth)/auth/callback/

    **src/app/(auth)/auth/callback/route.ts**:
    ```typescript
    import { createClient } from '@/lib/supabase/server'
    import { NextResponse } from 'next/server'

    export async function GET(request: Request) {
      const { searchParams, origin } = new URL(request.url)
      const code = searchParams.get('code')
      const next = searchParams.get('next') ?? '/onboarding'
      const error = searchParams.get('error')
      const errorDescription = searchParams.get('error_description')

      // Handle OAuth errors
      if (error) {
        console.error('OAuth error:', error, errorDescription)
        return NextResponse.redirect(`${origin}/?error=auth`)
      }

      if (code) {
        const supabase = await createClient()
        const { error: exchangeError } = await supabase.auth.exchangeCodeForSession(code)

        if (!exchangeError) {
          // Check if user has completed onboarding
          const { data: profile } = await supabase
            .from('profiles')
            .select('onboarding_completed')
            .single()

          if (profile?.onboarding_completed) {
            return NextResponse.redirect(`${origin}/dashboard`)
          }
          return NextResponse.redirect(`${origin}${next}`)
        }

        console.error('Code exchange error:', exchangeError)
      }

      // OAuth error - redirect to home with error param
      return NextResponse.redirect(`${origin}/?error=auth`)
    }
    ```

    This handler:
    1. Extracts the OAuth code from query params
    2. Exchanges code for session via Supabase
    3. Checks onboarding status to determine redirect
    4. Handles errors by redirecting to home with error param
  </action>
  <verify>
    Run `npm run build` to confirm TypeScript compiles
    Verify the route exists at src/app/(auth)/auth/callback/route.ts
  </verify>
  <done>
    OAuth callback route handler created. Exchanges authorization code for session and redirects based on onboarding status.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create auth UI components</name>
  <files>
    src/components/auth/auth-modal.tsx
    src/components/auth/signup-form.tsx
    src/components/auth/login-form.tsx
  </files>
  <action>
    Create src/components/auth/ directory with modal and form components.

    **src/components/auth/signup-form.tsx**:
    ```typescript
    'use client'

    import { useState } from 'react'
    import { useFormStatus } from 'react-dom'
    import { Button } from '@/components/ui/button'
    import { Input } from '@/components/ui/input'
    import { Label } from '@/components/ui/label'
    import { signUp, type AuthResult } from '@/actions/auth'
    import { createClient } from '@/lib/supabase/client'

    function SubmitButton() {
      const { pending } = useFormStatus()
      return (
        <Button type="submit" className="w-full" disabled={pending}>
          {pending ? 'Creating account...' : 'Create account'}
        </Button>
      )
    }

    interface SignupFormProps {
      onSwitchToLogin: () => void
    }

    export function SignupForm({ onSwitchToLogin }: SignupFormProps) {
      const [result, setResult] = useState<AuthResult>({})

      async function handleGoogleSignIn() {
        const supabase = createClient()
        const { error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: `${window.location.origin}/auth/callback?next=/onboarding`,
          },
        })
        if (error) {
          setResult({ error: 'Unable to sign in with Google. Please try again.' })
        }
      }

      async function handleSubmit(formData: FormData) {
        const res = await signUp(formData)
        if (res) setResult(res)
      }

      return (
        <div className="space-y-4">
          {/* Google OAuth - at top per CONTEXT.md */}
          <Button
            type="button"
            variant="outline"
            className="w-full"
            onClick={handleGoogleSignIn}
          >
            <svg className="mr-2 h-4 w-4" viewBox="0 0 24 24">
              <path
                fill="currentColor"
                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
              />
              <path
                fill="currentColor"
                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
              />
              <path
                fill="currentColor"
                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
              />
              <path
                fill="currentColor"
                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
              />
            </svg>
            Continue with Google
          </Button>

          {/* Divider */}
          <div className="relative">
            <div className="absolute inset-0 flex items-center">
              <span className="w-full border-t" />
            </div>
            <div className="relative flex justify-center text-xs uppercase">
              <span className="bg-background px-2 text-muted-foreground">
                Or continue with email
              </span>
            </div>
          </div>

          {/* General error */}
          {result.error && (
            <p className="text-sm text-destructive text-center">{result.error}</p>
          )}

          {/* Email/password form */}
          <form action={handleSubmit} className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input
                id="email"
                name="email"
                type="email"
                placeholder="you@example.com"
                required
              />
              {result.fieldErrors?.email && (
                <p className="text-sm text-destructive">{result.fieldErrors.email[0]}</p>
              )}
            </div>

            <div className="space-y-2">
              <Label htmlFor="password">Password</Label>
              <Input
                id="password"
                name="password"
                type="password"
                placeholder="At least 8 characters"
                required
              />
              {result.fieldErrors?.password && (
                <p className="text-sm text-destructive">{result.fieldErrors.password[0]}</p>
              )}
            </div>

            <SubmitButton />
          </form>

          {/* Switch to login */}
          <p className="text-center text-sm text-muted-foreground">
            Already have an account?{' '}
            <button
              type="button"
              onClick={onSwitchToLogin}
              className="text-primary underline-offset-4 hover:underline"
            >
              Sign in
            </button>
          </p>
        </div>
      )
    }
    ```

    **src/components/auth/login-form.tsx**:
    ```typescript
    'use client'

    import { useState } from 'react'
    import { useFormStatus } from 'react-dom'
    import { Button } from '@/components/ui/button'
    import { Input } from '@/components/ui/input'
    import { Label } from '@/components/ui/label'
    import { signIn, type AuthResult } from '@/actions/auth'
    import { createClient } from '@/lib/supabase/client'

    function SubmitButton() {
      const { pending } = useFormStatus()
      return (
        <Button type="submit" className="w-full" disabled={pending}>
          {pending ? 'Signing in...' : 'Sign in'}
        </Button>
      )
    }

    interface LoginFormProps {
      onSwitchToSignup: () => void
    }

    export function LoginForm({ onSwitchToSignup }: LoginFormProps) {
      const [result, setResult] = useState<AuthResult>({})

      async function handleGoogleSignIn() {
        const supabase = createClient()
        const { error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: `${window.location.origin}/auth/callback`,
          },
        })
        if (error) {
          setResult({ error: 'Unable to sign in with Google. Please try again.' })
        }
      }

      async function handleSubmit(formData: FormData) {
        const res = await signIn(formData)
        if (res) setResult(res)
      }

      return (
        <div className="space-y-4">
          {/* Google OAuth - at top per CONTEXT.md */}
          <Button
            type="button"
            variant="outline"
            className="w-full"
            onClick={handleGoogleSignIn}
          >
            <svg className="mr-2 h-4 w-4" viewBox="0 0 24 24">
              <path
                fill="currentColor"
                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
              />
              <path
                fill="currentColor"
                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
              />
              <path
                fill="currentColor"
                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
              />
              <path
                fill="currentColor"
                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
              />
            </svg>
            Continue with Google
          </Button>

          {/* Divider */}
          <div className="relative">
            <div className="absolute inset-0 flex items-center">
              <span className="w-full border-t" />
            </div>
            <div className="relative flex justify-center text-xs uppercase">
              <span className="bg-background px-2 text-muted-foreground">
                Or continue with email
              </span>
            </div>
          </div>

          {/* General error */}
          {result.error && (
            <p className="text-sm text-destructive text-center">{result.error}</p>
          )}

          {/* Email/password form */}
          <form action={handleSubmit} className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input
                id="email"
                name="email"
                type="email"
                placeholder="you@example.com"
                required
              />
              {result.fieldErrors?.email && (
                <p className="text-sm text-destructive">{result.fieldErrors.email[0]}</p>
              )}
            </div>

            <div className="space-y-2">
              <Label htmlFor="password">Password</Label>
              <Input
                id="password"
                name="password"
                type="password"
                required
              />
              {result.fieldErrors?.password && (
                <p className="text-sm text-destructive">{result.fieldErrors.password[0]}</p>
              )}
            </div>

            <SubmitButton />
          </form>

          {/* Switch to signup */}
          <p className="text-center text-sm text-muted-foreground">
            Don&apos;t have an account?{' '}
            <button
              type="button"
              onClick={onSwitchToSignup}
              className="text-primary underline-offset-4 hover:underline"
            >
              Sign up
            </button>
          </p>
        </div>
      )
    }
    ```

    **src/components/auth/auth-modal.tsx**:
    ```typescript
    'use client'

    import { useState, useEffect } from 'react'
    import {
      Dialog,
      DialogContent,
      DialogHeader,
      DialogTitle,
    } from '@/components/ui/dialog'
    import { LoginForm } from './login-form'
    import { SignupForm } from './signup-form'

    interface AuthModalProps {
      open: boolean
      onOpenChange: (open: boolean) => void
      defaultView?: 'login' | 'signup'
    }

    export function AuthModal({ open, onOpenChange, defaultView = 'signup' }: AuthModalProps) {
      const [view, setView] = useState<'login' | 'signup'>(defaultView)

      // Reset view when modal opens with a different default
      useEffect(() => {
        if (open) {
          setView(defaultView)
        }
      }, [open, defaultView])

      return (
        <Dialog open={open} onOpenChange={onOpenChange}>
          <DialogContent className="sm:max-w-[425px]">
            <DialogHeader>
              {/* Logo only at top per CONTEXT.md */}
              <div className="flex justify-center mb-2">
                <span className="text-2xl font-bold">Audy.not</span>
              </div>
              <DialogTitle className="text-center">
                {view === 'login' ? 'Welcome back' : 'Create an account'}
              </DialogTitle>
            </DialogHeader>

            {view === 'login' ? (
              <LoginForm onSwitchToSignup={() => setView('signup')} />
            ) : (
              <SignupForm onSwitchToLogin={() => setView('login')} />
            )}
          </DialogContent>
        </Dialog>
      )
    }
    ```
  </action>
  <verify>
    Run `npm run build` to confirm TypeScript compiles
    Verify all three files exist in src/components/auth/
    Verify each component exports the named export (AuthModal, SignupForm, LoginForm)
  </verify>
  <done>
    Auth UI components created: modal container, signup form, and login form. Forms include Google OAuth button at top, email/password fields with inline validation errors, and view switching between login and signup.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without TypeScript errors
2. src/actions/auth.ts exports signUp, signIn, signOut
3. src/app/(auth)/auth/callback/route.ts exists and exports GET
4. src/components/auth/ contains auth-modal.tsx, signup-form.tsx, login-form.tsx
5. Auth modal can be rendered with controlled open state
</verification>

<success_criteria>
- Server actions handle signup, login, and logout flows
- OAuth callback exchanges code for session
- Auth modal opens with signup or login view
- Google OAuth button at top of forms with divider
- Inline validation errors appear under form fields
- View can switch between login and signup
- Loading states show during form submission
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-04-SUMMARY.md`
</output>

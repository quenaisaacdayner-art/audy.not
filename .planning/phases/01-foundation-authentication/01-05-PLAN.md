---
phase: 01-foundation-authentication
plan: 05
type: execute
wave: 4
depends_on: ["01-02", "01-03", "01-04"]
files_modified:
  - src/app/(protected)/layout.tsx
  - src/app/(protected)/onboarding/page.tsx
  - src/app/(protected)/dashboard/page.tsx
  - src/app/page.tsx
autonomous: false

must_haves:
  truths:
    - "Unauthenticated user visiting /dashboard is redirected to /"
    - "Authenticated user with onboarding_completed=false lands on /onboarding"
    - "Authenticated user with onboarding_completed=true lands on /dashboard"
    - "User can click 'Get Started' on landing page and see signup modal"
    - "User can click 'Sign In' on landing page and see login modal"
  artifacts:
    - path: "src/app/(protected)/layout.tsx"
      provides: "Protected route layout with auth check"
      min_lines: 15
    - path: "src/app/(protected)/onboarding/page.tsx"
      provides: "Onboarding placeholder page"
      min_lines: 5
    - path: "src/app/(protected)/dashboard/page.tsx"
      provides: "Dashboard placeholder page"
      min_lines: 5
    - path: "src/app/page.tsx"
      provides: "Landing page with auth modal integration"
      min_lines: 30
  key_links:
    - from: "src/app/(protected)/layout.tsx"
      to: "src/lib/supabase/server.ts"
      via: "createClient import"
      pattern: "import.*createClient.*server"
    - from: "src/app/page.tsx"
      to: "src/components/auth/auth-modal.tsx"
      via: "AuthModal import and render"
      pattern: "<AuthModal"
---

<objective>
Create protected route layout, placeholder pages, and landing page with auth modal integration.

Purpose: This plan wires everything together into a working authentication flow. Users see the landing page, open auth modals, authenticate, and are routed to the correct destination based on their onboarding status.

Output: Complete authentication flow from landing page through signup/login to onboarding or dashboard.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@.planning/phases/01-foundation-authentication/01-02-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-03-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create protected route layout with auth and onboarding checks</name>
  <files>
    src/app/(protected)/layout.tsx
  </files>
  <action>
    Create the (protected) route group directory: src/app/(protected)/

    **src/app/(protected)/layout.tsx**:
    ```typescript
    import { createClient } from '@/lib/supabase/server'
    import { redirect } from 'next/navigation'

    export default async function ProtectedLayout({
      children,
    }: {
      children: React.ReactNode
    }) {
      const supabase = await createClient()

      // Verify user is authenticated (getUser validates with Supabase server)
      const { data: { user } } = await supabase.auth.getUser()

      if (!user) {
        redirect('/')
      }

      // Get user's profile to check onboarding status
      const { data: profile } = await supabase
        .from('profiles')
        .select('onboarding_completed')
        .single()

      // Route based on onboarding status
      // This check runs on every protected page load
      const pathname = new URL(
        (await import('next/headers')).headers().get('x-pathname') || '/onboarding',
        'http://localhost'
      ).pathname

      // If onboarding not completed and not already on onboarding page, redirect
      if (!profile?.onboarding_completed && !pathname.includes('/onboarding')) {
        redirect('/onboarding')
      }

      // If onboarding completed and on onboarding page, redirect to dashboard
      if (profile?.onboarding_completed && pathname.includes('/onboarding')) {
        redirect('/dashboard')
      }

      return <>{children}</>
    }
    ```

    Note: The pathname detection via headers may need adjustment. A simpler approach without pathname detection:

    **Alternative (simpler) src/app/(protected)/layout.tsx**:
    ```typescript
    import { createClient } from '@/lib/supabase/server'
    import { redirect } from 'next/navigation'

    export default async function ProtectedLayout({
      children,
    }: {
      children: React.ReactNode
    }) {
      const supabase = await createClient()

      // Verify user is authenticated
      const { data: { user } } = await supabase.auth.getUser()

      if (!user) {
        redirect('/')
      }

      return <>{children}</>
    }
    ```

    Use the simpler version. Onboarding redirection is already handled in:
    1. Server actions (signIn, signUp) after successful auth
    2. OAuth callback route handler

    The layout just needs to enforce authentication.
  </action>
  <verify>
    Run `npm run build` to confirm TypeScript compiles
    Verify src/app/(protected)/layout.tsx exists
  </verify>
  <done>
    Protected layout created that verifies user authentication. Unauthenticated users are redirected to the home page.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create onboarding and dashboard placeholder pages</name>
  <files>
    src/app/(protected)/onboarding/page.tsx
    src/app/(protected)/dashboard/page.tsx
  </files>
  <action>
    Create directories and placeholder pages.

    **src/app/(protected)/onboarding/page.tsx**:
    ```typescript
    import { createClient } from '@/lib/supabase/server'
    import { redirect } from 'next/navigation'
    import { Button } from '@/components/ui/button'
    import { signOut } from '@/actions/auth'

    export default async function OnboardingPage() {
      const supabase = await createClient()

      // Check if onboarding already completed
      const { data: profile } = await supabase
        .from('profiles')
        .select('onboarding_completed')
        .single()

      if (profile?.onboarding_completed) {
        redirect('/dashboard')
      }

      return (
        <main className="flex min-h-screen flex-col items-center justify-center p-4">
          <div className="w-full max-w-md space-y-8 text-center">
            <h1 className="text-3xl font-bold">Welcome to Audy.not</h1>
            <p className="text-muted-foreground">
              Let&apos;s get you set up. Onboarding flow coming in Phase 2.
            </p>

            {/* Placeholder - Phase 2 will add the real onboarding steps */}
            <div className="rounded-lg border p-6 text-left">
              <p className="text-sm text-muted-foreground">
                Phase 1 complete! You&apos;ve successfully authenticated.
                The onboarding flow (Telegram connection, persona configuration,
                and first product setup) will be implemented in Phase 2.
              </p>
            </div>

            <form action={signOut}>
              <Button type="submit" variant="outline">
                Sign out
              </Button>
            </form>
          </div>
        </main>
      )
    }
    ```

    **src/app/(protected)/dashboard/page.tsx**:
    ```typescript
    import { createClient } from '@/lib/supabase/server'
    import { redirect } from 'next/navigation'
    import { Button } from '@/components/ui/button'
    import { signOut } from '@/actions/auth'

    export default async function DashboardPage() {
      const supabase = await createClient()

      // Get user and profile
      const { data: { user } } = await supabase.auth.getUser()
      const { data: profile } = await supabase
        .from('profiles')
        .select('*')
        .single()

      // Redirect to onboarding if not completed
      if (!profile?.onboarding_completed) {
        redirect('/onboarding')
      }

      return (
        <main className="flex min-h-screen flex-col items-center justify-center p-4">
          <div className="w-full max-w-md space-y-8 text-center">
            <h1 className="text-3xl font-bold">Dashboard</h1>
            <p className="text-muted-foreground">
              Welcome back, {profile?.full_name || user?.email}!
            </p>

            {/* Placeholder - Phase 5 will add the real dashboard */}
            <div className="rounded-lg border p-6 text-left">
              <p className="text-sm text-muted-foreground">
                Dashboard coming in Phase 5. This placeholder confirms
                that authentication and routing are working correctly.
              </p>
            </div>

            <form action={signOut}>
              <Button type="submit" variant="outline">
                Sign out
              </Button>
            </form>
          </div>
        </main>
      )
    }
    ```
  </action>
  <verify>
    Run `npm run build` to confirm TypeScript compiles
    Verify both page files exist in src/app/(protected)/
  </verify>
  <done>
    Onboarding and dashboard placeholder pages created. Both pages check onboarding status and redirect appropriately. Sign out functionality included.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create landing page with auth modal integration</name>
  <files>
    src/app/page.tsx
  </files>
  <action>
    Replace the placeholder landing page with one that integrates the auth modal.

    **src/app/page.tsx**:
    ```typescript
    'use client'

    import { useState, useEffect } from 'react'
    import { useSearchParams } from 'next/navigation'
    import { Button } from '@/components/ui/button'
    import { AuthModal } from '@/components/auth/auth-modal'

    export default function Home() {
      const [authModalOpen, setAuthModalOpen] = useState(false)
      const [authView, setAuthView] = useState<'login' | 'signup'>('signup')
      const searchParams = useSearchParams()

      // Show error if redirected from failed auth
      const authError = searchParams.get('error')

      function openSignup() {
        setAuthView('signup')
        setAuthModalOpen(true)
      }

      function openLogin() {
        setAuthView('login')
        setAuthModalOpen(true)
      }

      return (
        <main className="flex min-h-screen flex-col">
          {/* Header */}
          <header className="border-b">
            <div className="container mx-auto flex h-16 items-center justify-between px-4">
              <span className="text-xl font-bold">Audy.not</span>
              <div className="flex items-center gap-4">
                <Button variant="ghost" onClick={openLogin}>
                  Sign in
                </Button>
                <Button onClick={openSignup}>
                  Get started
                </Button>
              </div>
            </div>
          </header>

          {/* Hero */}
          <section className="flex flex-1 flex-col items-center justify-center px-4 text-center">
            <h1 className="max-w-3xl text-4xl font-bold tracking-tight sm:text-5xl md:text-6xl">
              Reddit opportunities, delivered to Telegram
            </h1>
            <p className="mt-6 max-w-xl text-lg text-muted-foreground">
              Audy.not monitors Reddit for people who need your product.
              AI drafts personalized replies. You approve and post.
            </p>
            <div className="mt-10 flex flex-col gap-4 sm:flex-row">
              <Button size="lg" onClick={openSignup}>
                Start free trial
              </Button>
              <Button size="lg" variant="outline" onClick={openLogin}>
                Sign in
              </Button>
            </div>

            {/* Auth error message */}
            {authError && (
              <p className="mt-4 text-sm text-destructive">
                Authentication failed. Please try again.
              </p>
            )}
          </section>

          {/* Auth Modal */}
          <AuthModal
            open={authModalOpen}
            onOpenChange={setAuthModalOpen}
            defaultView={authView}
          />
        </main>
      )
    }
    ```

    This landing page:
    1. Shows header with Sign in and Get started buttons
    2. Displays hero section with value proposition
    3. Opens auth modal with appropriate view (login/signup)
    4. Shows error message if redirected from failed OAuth
    5. Landing page remains visible behind modal (dimmed backdrop from shadcn Dialog)
  </action>
  <verify>
    Run `npm run dev` and verify:
    1. Landing page renders with header and hero
    2. "Get started" opens signup modal
    3. "Sign in" opens login modal
    4. Modal has dimmed backdrop with landing page visible behind
    5. Modal can be closed by clicking outside or pressing Escape
  </verify>
  <done>
    Landing page created with auth modal integration. Buttons open signup or login views, modal overlays the landing page with dimmed backdrop.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without TypeScript errors
2. `npm run dev` starts successfully
3. Landing page shows at http://localhost:3000
4. "Get started" button opens signup modal
5. "Sign in" button opens login modal
6. Attempting to visit /dashboard redirects to / (when not authenticated)
7. Attempting to visit /onboarding redirects to / (when not authenticated)
</verification>

<success_criteria>
- Landing page displays with header and hero section
- Auth modal opens with controlled state from landing page buttons
- Protected routes redirect unauthenticated users to home
- Onboarding page shows for authenticated users without onboarding_completed
- Dashboard page shows for authenticated users with onboarding_completed
- Sign out functionality works from both pages
</success_criteria>

<checkpoint type="human-verify" gate="blocking">
  <what-built>
    Complete authentication flow:
    1. Landing page with auth modal integration
    2. Email/password signup and login
    3. Google OAuth signup and login
    4. Protected routes with auth checks
    5. Onboarding and dashboard placeholders
  </what-built>
  <how-to-verify>
    Prerequisites: Ensure .env.local is configured with Supabase credentials and the SQL migration has been run in Supabase Dashboard.

    Test flow 1 - Email signup:
    1. Visit http://localhost:3000
    2. Click "Get started"
    3. Enter email and password (8+ chars)
    4. Click "Create account"
    5. Verify redirect to /onboarding
    6. Click "Sign out" and verify redirect to landing page

    Test flow 2 - Google OAuth:
    1. Visit http://localhost:3000
    2. Click "Get started"
    3. Click "Continue with Google"
    4. Complete Google sign-in
    5. Verify redirect to /onboarding

    Test flow 3 - Login existing user:
    1. Visit http://localhost:3000
    2. Click "Sign in"
    3. Enter existing user credentials
    4. Click "Sign in"
    5. Verify redirect to /onboarding (or /dashboard if onboarding_completed)

    Test flow 4 - Session persistence:
    1. Sign in
    2. Close browser tab
    3. Open new tab, visit http://localhost:3000/onboarding
    4. Verify you're still logged in (no redirect to /)

    Test flow 5 - Protected route:
    1. Sign out (or use incognito)
    2. Visit http://localhost:3000/dashboard directly
    3. Verify redirect to /

    Note: If Google OAuth fails with redirect_uri_mismatch, the callback URL needs to be configured in Google Cloud Console.
  </how-to-verify>
  <resume-signal>Type "approved" if all flows work, or describe any issues found</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-05-SUMMARY.md`
</output>

---
phase: 01-foundation-authentication
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - supabase/migrations/00001_profiles.sql
autonomous: true
user_setup:
  - service: supabase
    why: "Database hosting and authentication provider"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon public key"
    dashboard_config:
      - task: "Create new Supabase project"
        location: "https://supabase.com/dashboard -> New Project"
      - task: "Enable Google OAuth provider"
        location: "Supabase Dashboard -> Authentication -> Providers -> Google"
      - task: "Configure Google OAuth credentials"
        location: "Google Cloud Console -> APIs & Services -> Credentials"

must_haves:
  truths:
    - "profiles table exists in Supabase database"
    - "New user signup automatically creates a profile row"
    - "Users can only read and update their own profile"
    - "onboarding_completed flag defaults to false"
  artifacts:
    - path: "supabase/migrations/00001_profiles.sql"
      provides: "Database schema for profiles"
      contains: "create table public.profiles"
  key_links:
    - from: "auth.users"
      to: "public.profiles"
      via: "trigger on_auth_user_created"
      pattern: "after insert on auth.users"
---

<objective>
Create the database schema for user profiles with automatic creation on signup.

Purpose: The profiles table stores user-specific data beyond what Supabase Auth provides (like onboarding_completed flag). The trigger ensures every authenticated user has a corresponding profile row, enabling the onboarding flow to work correctly.

Output: SQL migration file that creates the profiles table, RLS policies, and auto-creation trigger.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profiles table migration</name>
  <files>
    supabase/migrations/00001_profiles.sql
  </files>
  <action>
    Create supabase/migrations/ directory in project root.

    Create 00001_profiles.sql with the complete schema:

    ```sql
    -- Create profiles table
    -- This table extends auth.users with application-specific data
    create table public.profiles (
      id uuid primary key references auth.users(id) on delete cascade,
      email text,
      full_name text,
      onboarding_completed boolean default false,
      created_at timestamptz default now(),
      updated_at timestamptz default now()
    );

    -- Add comment for documentation
    comment on table public.profiles is 'User profiles extending auth.users with app-specific data';

    -- Enable Row Level Security
    alter table public.profiles enable row level security;

    -- RLS Policy: Users can view their own profile
    create policy "Users can view own profile"
      on public.profiles for select
      to authenticated
      using (auth.uid() = id);

    -- RLS Policy: Users can update their own profile
    create policy "Users can update own profile"
      on public.profiles for update
      to authenticated
      using (auth.uid() = id);

    -- Function to handle new user signup
    -- Creates a profile row automatically when a user signs up
    create or replace function public.handle_new_user()
    returns trigger
    language plpgsql
    security definer set search_path = public
    as $$
    begin
      insert into public.profiles (id, email, full_name)
      values (
        new.id,
        new.email,
        coalesce(new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'name')
      );
      return new;
    end;
    $$;

    -- Trigger: Run handle_new_user() after auth.users insert
    create or replace trigger on_auth_user_created
      after insert on auth.users
      for each row execute procedure public.handle_new_user();

    -- Function to update updated_at timestamp
    create or replace function public.handle_updated_at()
    returns trigger
    language plpgsql
    as $$
    begin
      new.updated_at = now();
      return new;
    end;
    $$;

    -- Trigger: Update updated_at on profile changes
    create or replace trigger on_profile_updated
      before update on public.profiles
      for each row execute procedure public.handle_updated_at();
    ```

    This SQL needs to be run in the Supabase SQL Editor. The migration file serves as:
    1. Documentation of the schema
    2. Source of truth for the database structure
    3. Reference for future migrations
  </action>
  <verify>
    Verify the SQL file exists at supabase/migrations/00001_profiles.sql
    Verify the SQL is syntactically valid (no obvious errors)

    Note: Actual execution happens via Supabase Dashboard SQL Editor
  </verify>
  <done>
    SQL migration file created with profiles table, RLS policies, and auto-creation trigger. Ready to be executed in Supabase Dashboard.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types for profiles</name>
  <files>
    src/types/database.ts
  </files>
  <action>
    Create src/types/ directory and database.ts with TypeScript types matching the database schema.

    **src/types/database.ts**:
    ```typescript
    export interface Profile {
      id: string
      email: string | null
      full_name: string | null
      onboarding_completed: boolean
      created_at: string
      updated_at: string
    }

    // For Supabase client type inference
    export interface Database {
      public: {
        Tables: {
          profiles: {
            Row: Profile
            Insert: Omit<Profile, 'created_at' | 'updated_at'> & {
              created_at?: string
              updated_at?: string
            }
            Update: Partial<Omit<Profile, 'id' | 'created_at'>>
          }
        }
      }
    }
    ```

    These types will be used for type-safe database queries throughout the application.
  </action>
  <verify>
    Run `npm run build` to confirm TypeScript compiles
    Verify types are exported from src/types/database.ts
  </verify>
  <done>
    TypeScript types created for profiles table matching the database schema. Types ready for use with Supabase client queries.
  </done>
</task>

</tasks>

<verification>
1. supabase/migrations/00001_profiles.sql exists and contains valid SQL
2. src/types/database.ts exports Profile and Database types
3. `npm run build` passes
</verification>

<success_criteria>
- SQL migration file documents the complete profiles schema
- RLS policies ensure users can only access their own data
- Trigger function handles automatic profile creation on signup
- TypeScript types match database schema for type-safe queries
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-03-SUMMARY.md`

Note: The SQL migration must be executed manually in Supabase Dashboard -> SQL Editor before testing auth flows. This is a one-time setup step.
</output>
